{"version":3,"sources":["../src/client-connection.ts"],"names":["PSConnection","socket","connected","queue","connect","server","PS","port","protocol","url","host","prefix","SockJS","timeout","onopen","console","log","msg","send","update","onmessage","e","receive","data","onclose","isOffline","roomid","rooms","push","connection","PSLoginServer","query","id","location","pathname","endsWith","Config","routes","client","POKEMON_SHOWDOWN_TESTCLIENT_KEY","sid","replace","Net","get","method","body","then","res","JSON","parse","slice","HttpError","message","statusCode","name","Error","captureStackTrace","err","NetRequest","uri","opts","Promise","resolve","reject","xhr","XMLHttpRequest","includes","encodeQuery","open","onreadystatechange","DONE","readyState","status","responseText","statusText","setRequestHeader","post","urlencodedData","key","encodeURIComponent"],"mappings":"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","sourcesContent":["/**\n * Connection library\n *\n * @author Guangcong Luo <guangcongluo@gmail.com>\n * @license MIT\n */\n\ndeclare var SockJS: any;\n\nclass PSConnection {\n\tsocket: any = null;\n\tconnected = false;\n\tqueue = [] as string[];\n\tconstructor() {\n\t\tthis.connect();\n\t}\n\tconnect() {\n\t\tconst server = PS.server;\n\t\tconst port = server.protocol === 'https' ? '' : ':' + server.port;\n\t\tconst url = server.protocol + '://' + server.host + port + server.prefix;\n\t\tconst socket = this.socket = new SockJS(url, [], {timeout: 5 * 60 * 1000});\n\t\tsocket.onopen = () => {\n\t\t\tconsole.log('\\u2705 (CONNECTED)');\n\t\t\tthis.connected = true;\n\t\t\tPS.connected = true;\n\t\t\tfor (const msg of this.queue) socket.send(msg);\n\t\t\tthis.queue = [];\n\t\t\tPS.update();\n\t\t};\n\t\tsocket.onmessage = (e: MessageEvent) => {\n\t\t\tPS.receive('' + e.data);\n\t\t};\n\t\tsocket.onclose = () => {\n\t\t\tconsole.log('\\u2705 (DISCONNECTED)');\n\t\t\tthis.connected = false;\n\t\t\tPS.connected = false;\n\t\t\tPS.isOffline = true;\n\t\t\tfor (const roomid in PS.rooms) {\n\t\t\t\tPS.rooms[roomid]!.connected = false;\n\t\t\t}\n\t\t\tthis.socket = null;\n\t\t\tPS.update();\n\t\t};\n\t}\n\tsend(msg: string) {\n\t\tif (!this.connected) {\n\t\t\tthis.queue.push(msg);\n\t\t\treturn;\n\t\t}\n\t\tthis.socket.send(msg);\n\t}\n}\n\nPS.connection = new PSConnection();\n\nconst PSLoginServer = new class {\n\tquery(data: PostData): Promise<{[k: string]: any} | null> {\n\t\tlet url = '/~~' + PS.server.id + '/action.php';\n\t\tif (location.pathname.endsWith('.html')) {\n\t\t\turl = 'https://' + Config.routes.client + url;\n\t\t\t// @ts-ignore\n\t\t\tif (typeof POKEMON_SHOWDOWN_TESTCLIENT_KEY === 'string') {\n\t\t\t\t// @ts-ignore\n\t\t\t\tdata.sid = POKEMON_SHOWDOWN_TESTCLIENT_KEY.replace(/\\%2C/g, ',');\n\t\t\t}\n\t\t}\n\t\treturn Net(url).get({method: data ? 'POST' : 'GET', body: data}).then(\n\t\t\tres => res ? JSON.parse(res.slice(1)) : null\n\t\t).catch(\n\t\t\t() => null\n\t\t);\n\t}\n};\n\ninterface PostData {\n\t[key: string]: string | number;\n}\ninterface NetRequestOptions {\n\tmethod?: 'GET' | 'POST';\n\tbody?: string | PostData;\n\tquery?: PostData;\n}\nclass HttpError extends Error {\n\tstatusCode?: number;\n\tbody: string;\n\tconstructor(message: string, statusCode: number | undefined, body: string) {\n\t\tsuper(message);\n\t\tthis.name = 'HttpError';\n\t\tthis.statusCode = statusCode;\n\t\tthis.body = body;\n\t\ttry {\n\t\t\t(Error as any).captureStackTrace(this, HttpError);\n\t\t} catch (err) {}\n\t}\n}\nclass NetRequest {\n\turi: string;\n\tconstructor(uri: string) {\n\t\tthis.uri = uri;\n\t}\n\n\t/**\n\t * Makes a basic http/https request to the URI.\n\t * Returns the response data.\n\t *\n\t * Will throw if the response code isn't 200 OK.\n\t *\n\t * @param opts request opts\n\t */\n\tget(opts: NetRequestOptions = {}): Promise<string> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst xhr = new XMLHttpRequest();\n\t\t\tlet uri = this.uri;\n\t\t\tif (opts.query) {\n\t\t\t\turi += (uri.includes('?') ? '&' : '?') + Net.encodeQuery(opts.query);\n\t\t\t}\n\t\t\txhr.open(opts.method || 'GET', uri);\n\t\t\txhr.onreadystatechange = function () {\n\t\t\t\tconst DONE = 4;\n\t\t\t\tif (xhr.readyState === DONE) {\n\t\t\t\t\tif (xhr.status === 200) {\n\t\t\t\t\t\tresolve(xhr.responseText || '');\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tconst err = new HttpError(xhr.statusText || \"Connection error\", xhr.status, xhr.responseText);\n\t\t\t\t\treject(err);\n\t\t\t\t}\n\t\t\t};\n\t\t\tif (opts.body) {\n\t\t\t\txhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\n\t\t\t\txhr.send(Net.encodeQuery(opts.body));\n\t\t\t} else {\n\t\t\t\txhr.send();\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Makes a http/https POST request to the given link.\n\t * @param opts request opts\n\t * @param body POST body\n\t */\n\tpost(opts: Omit<NetRequestOptions, 'body'>, body: PostData | string): Promise<string>;\n\t/**\n\t * Makes a http/https POST request to the given link.\n\t * @param opts request opts\n\t */\n\tpost(opts?: NetRequestOptions): Promise<string>;\n\tpost(opts: NetRequestOptions = {}, body?: PostData | string) {\n\t\tif (!body) body = opts.body;\n\t\treturn this.get({\n\t\t\t...opts,\n\t\t\tmethod: 'POST',\n\t\t\tbody,\n\t\t});\n\t}\n}\n\nfunction Net(uri: string) {\n\treturn new NetRequest(uri);\n}\n\nNet.encodeQuery = function (data: string | PostData) {\n\tif (typeof data === 'string') return data;\n\tlet urlencodedData = '';\n\tfor (const key in data) {\n\t\tif (urlencodedData) urlencodedData += '&';\n\t\turlencodedData += encodeURIComponent(key) + '=' + encodeURIComponent((data as any)[key]);\n\t}\n\treturn urlencodedData;\n};\n"],"file":"client-connection.js"}